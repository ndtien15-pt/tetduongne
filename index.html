<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Happy New Year 2026 - Simulation</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #000;
        }
        canvas {
            display: block;
            cursor: pointer;
        }
        /* Nút Start để kích hoạt nhạc */
        #start-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex; justify-content: center; align-items: center;
            z-index: 999; transition: opacity 0.8s;
        }
        #btn-start {
            padding: 20px 50px;
            font-size: 24px;
            color: #fff;
            background: transparent;
            border: 2px solid #fff;
            cursor: pointer;
            letter-spacing: 4px;
            text-transform: uppercase;
            font-family: sans-serif;
            transition: 0.3s;
        }
        #btn-start:hover {
            background: #fff; color: #000; box-shadow: 0 0 40px #fff;
        }
    </style>
</head>
<body>

<div id="start-overlay">
    <button id="btn-start">KHỞI ĐỘNG 2026</button>
</div>

<audio id="audio" src="music.mp3"></audio>
<canvas id="canvas"></canvas>

<script>
    // --- CẤU HÌNH VẬT LÝ (PHYSICS ENGINE) ---
    // Đây là thông số để pháo hoa giống cái web ông gửi
    const CONFIG = {
        friction: 0.98,     // Độ cản gió (giúp tàn lửa bay chậm lại)
        gravity: 0.03,      // Trọng lực (kéo tàn rơi xuống)
        trail: 0.15,        // Độ dài đuôi
        explosionPower: 7,  // Sức nổ
        hueSpeed: 2         // Tốc độ đổi màu
    };

    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    let particles = [];
    let fireworks = [];
    let textParticles = []; // Chứa hạt cát chữ 2026
    let timer = 0;
    let hue = 120;
    
    // TRẠNG THÁI (STATE MACHINE)
    let state = "waiting"; // waiting -> countdown -> happy -> clear -> final2026
    let countdownVal = 6;  // Bắt đầu đếm từ 5 (code trừ trước 1 nhịp)
    let lastTime = 0;

    // --- LỚP PHÁO HOA (REALISTIC) ---
    class Firework {
        constructor(sx, sy, tx, ty) {
            this.x = sx;
            this.y = sy;
            this.sx = sx;
            this.sy = sy;
            this.tx = tx;
            this.ty = ty;
            this.distanceToTarget = Math.hypot(sx - tx, sy - ty);
            this.distanceTraveled = 0;
            this.coordinates = [];
            this.coordinateCount = 3;
            while(this.coordinateCount--) {
                this.coordinates.push([this.x, this.y]);
            }
            this.angle = Math.atan2(ty - sy, tx - sx);
            this.speed = 2;
            this.acceleration = 1.05;
            this.brightness = Math.random() * 50 + 50;
            this.targetRadius = 1;
        }

        update(index) {
            this.coordinates.pop();
            this.coordinates.unshift([this.x, this.y]);
            this.speed *= this.acceleration;
            
            const vx = Math.cos(this.angle) * this.speed;
            const vy = Math.sin(this.angle) * this.speed;
            
            this.distanceTraveled = Math.hypot(this.sx - this.x, this.sy - this.y);

            if (this.distanceTraveled >= this.distanceToTarget) {
                // Nổ!
                createParticles(this.tx, this.ty);
                fireworks.splice(index, 1);
            } else {
                this.x += vx;
                this.y += vy;
            }
        }

        draw() {
            ctx.beginPath();
            ctx.moveTo(this.coordinates[this.coordinates.length - 1][0], this.coordinates[this.coordinates.length - 1][1]);
            ctx.lineTo(this.x, this.y);
            ctx.strokeStyle = `hsl(${hue}, 100%, ${this.brightness}%)`;
            ctx.stroke();
        }
    }

    class Particle {
        constructor(x, y) {
            this.x = x;
            this.y = y;
            this.coordinates = [];
            this.coordinateCount = 5;
            while(this.coordinateCount--) {
                this.coordinates.push([this.x, this.y]);
            }
            this.angle = Math.random() * Math.PI * 2;
            this.speed = Math.random() * 10 + 1; // Nổ to
            this.friction = CONFIG.friction;
            this.gravity = CONFIG.gravity;
            this.hue = Math.random() * 20 + hue;
            this.brightness = Math.random() * 50 + 50;
            this.alpha = 1;
            this.decay = Math.random() * 0.015 + 0.005; // Tan biến chậm
        }

        update(index) {
            this.coordinates.pop();
            this.coordinates.unshift([this.x, this.y]);
            this.speed *= this.friction;
            this.x += Math.cos(this.angle) * this.speed;
            this.y += Math.sin(this.angle) * this.speed + this.gravity;
            this.alpha -= this.decay;

            if (this.alpha <= this.decay) {
                particles.splice(index, 1);
            }
        }

        draw() {
            ctx.beginPath();
            ctx.moveTo(this.coordinates[this.coordinates.length - 1][0], this.coordinates[this.coordinates.length - 1][1]);
            ctx.lineTo(this.x, this.y);
            // Chế độ màu rực rỡ (HSLA)
            ctx.strokeStyle = `hsla(${this.hue}, 100%, ${this.brightness}%, ${this.alpha})`;
            ctx.stroke();
        }
    }

    function createParticles(x, y) {
        let particleCount = 100; // Số lượng tàn lửa
        while(particleCount--) {
            particles.push(new Particle(x, y));
        }
    }

    // --- LỚP HẠT CÁT CHỮ (SAND TEXT) ---
    class SandParticle {
        constructor(x, y) {
            this.x = Math.random() * canvas.width;
            this.y = Math.random() * canvas.height;
            this.destX = x;
            this.destY = y;
            this.size = 1.5; // Hạt mịn
            // Màu vàng kim loại (Gold) pha trắng
            this.color = Math.random() > 0.3 ? '#ffd700' : '#ffffff';
            this.vx = (Math.random() - 0.5) * 20;
            this.vy = (Math.random() - 0.5) * 20;
            this.accX = 0;
            this.accY = 0;
            this.friction = 0.92;
        }

        update() {
            // Vật lý bay về đích
            this.accX = (this.destX - this.x) / 300; // Lực hút
            this.accY = (this.destY - this.y) / 300;
            this.vx += this.accX;
            this.vy += this.accY;
            this.vx *= this.friction;
            this.vy *= this.friction;

            this.x += this.vx;
            this.y += this.vy;
        }

        draw() {
            ctx.fillStyle = this.color;
            ctx.beginPath();
            ctx.fillRect(this.x, this.y, this.size, this.size);
        }
    }

    // --- XỬ LÝ TEXT ---
    function initSandText(text) {
        textParticles = [];
        // Vẽ chữ lên canvas ẩn để lấy pixel
        ctx.clearRect(0,0,canvas.width, canvas.height);
        
        let fontSize = 200;
        if (canvas.width < 600) fontSize = 100;
        
        ctx.font = `900 ${fontSize}px Arial`;
        ctx.fillStyle = "white";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(text, canvas.width/2, canvas.height/2);

        const data = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
        const gap = 4; // Độ mịn

        for (let y = 0; y < canvas.height; y += gap) {
            for (let x = 0; x < canvas.width; x += gap) {
                if (data[(y * canvas.width + x) * 4 + 3] > 128) {
                    textParticles.push(new SandParticle(x, y));
                }
            }
        }
    }

    // --- LOOP CHÍNH ---
    function loop() {
        requestAnimationFrame(loop);
        
        hue += 0.5;

        // Xóa màn hình với vệt mờ (Trail Effect)
        ctx.globalCompositeOperation = 'destination-out';
        ctx.fillStyle = `rgba(0, 0, 0, 0.2)`; 
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // Vẽ đè lên (Light Blend) -> Giúp pháo hoa sáng rực
        ctx.globalCompositeOperation = 'lighter';

        // 1. Logic Pháo hoa
        let i = fireworks.length;
        while(i--) {
            fireworks[i].draw();
            fireworks[i].update(i);
        }
        let j = particles.length;
        while(j--) {
            particles[j].draw();
            particles[j].update(j);
        }

        // Tự động bắn pháo ngẫu nhiên (chỉ khi không phải ở đoạn 2026)
        if (state !== 'final2026' && state !== 'clear') {
            if(timerTick % 20 === 0) { // Bắn lai rai
                fireworks.push(new Firework(canvas.width/2, canvas.height, Math.random()*canvas.width, Math.random()*canvas.height/2));
            }
        } else if (state === 'final2026') {
             // Đoạn cuối bắn nhiều pháo 2 bên để tôn chữ 2026
             if(Math.random() < 0.1) {
                 fireworks.push(new Firework(Math.random() > 0.5 ? 0 : canvas.width, canvas.height, Math.random()*canvas.width, Math.random()*canvas.height/3));
             }
        }

        // 2. Logic Hiển thị Text theo kịch bản
        ctx.globalCompositeOperation = 'source-over'; // Chữ thì không blend
        
        if (state === 'countdown') {
            ctx.font = "bold 150px Arial";
            ctx.fillStyle = `hsl(${hue}, 100%, 60%)`;
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(countdownVal, canvas.width/2, canvas.height/2);
        } 
        else if (state === 'happy') {
            ctx.font = "bold 80px Arial";
            ctx.fillStyle = "#fff";
            ctx.shadowColor = "#ff00de";
            ctx.shadowBlur = 30;
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText("HAPPY NEW YEAR 2026", canvas.width/2, canvas.height/2);
            ctx.shadowBlur = 0; // Reset shadow
        }
        else if (state === 'final2026') {
            textParticles.forEach(p => {
                p.update();
                p.draw();
            });
        }
        
        timerTick++;
    }

    let timerTick = 0;

    // --- KỊCH BẢN THỜI GIAN (TIMELINE) ---
    function runSequence() {
        // Giai đoạn 1: Đếm ngược
        state = 'countdown';
        let countInterval = setInterval(() => {
            countdownVal--;
            if(countdownVal <= 0) {
                clearInterval(countInterval);
                triggerHappy();
            }
        }, 1000); // 1 giây đếm 1 số
    }

    function triggerHappy() {
        state = 'happy';
        // Bắn pháo hoa liên tục ăn mừng
        for(let i=0; i<10; i++) {
             setTimeout(() => {
                fireworks.push(new Firework(canvas.width/2, canvas.height, Math.random()*canvas.width, Math.random()*canvas.height/2));
             }, i * 200);
        }

        // Sau 3 giây thì xóa chữ Happy
        setTimeout(() => {
            state = 'clear'; // Màn hình trống 1 chút
            
            // Sau 1 giây nữa thì hiện chữ 2026 hạt cát
            setTimeout(() => {
                state = 'final2026';
                initSandText("2026");
            }, 1000);

        }, 3000);
    }

    // START
    document.getElementById('btn-start').addEventListener('click', function() {
        document.getElementById('start-overlay').style.opacity = 0;
        setTimeout(() => document.getElementById('start-overlay').style.display = 'none', 800);
        
        document.getElementById('audio').play().catch(e => console.log(e));
        
        loop(); // Chạy vòng lặp đồ họa
        runSequence(); // Chạy kịch bản
    });

    window.addEventListener('resize', () => {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    });
</script>
</body>
</html>